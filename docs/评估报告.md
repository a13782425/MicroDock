# MicroDock 代码评估报告（v0.0.1.0）

最后更新：2025-10-16

本报告从架构/分层、代码质量、性能与资源、跨平台与 Win 特性、UI/UX、数据持久化、插件机制、可观测性与日志、测试与构建、文档与发布等方面，对仓库当前实现进行评估，并给出分级（P0/P1/P2）改进建议与“快速收益”清单。

说明：本报告仅涉及静态代码审阅与运行逻辑推断，未覆盖大量交互性测试与多显示器/高 DPI 等复杂场景的全面验证。

- P0：建议优先修复（正确性/稳定性/用户可见问题/明显技术债）。
- P1：中优先级（可维护性/扩展性/体验提升）。
- P2：长期优化（工程化完善/架构演进）。


一、总体结论
- 项目结构清晰：Views / ViewModels / Services / Database / Models / Extension 分层相对明确，功能粒度合适，易于继续扩展。
- 功能覆盖紧凑：主窗体、系统托盘、自动启动/置顶/靠边隐藏服务、迷你模式（悬浮球+环形启动器）、SQLite 配置与应用列表、插件机制雏形均已具备。
- 可维护性基础较好：使用 ReactiveUI、Avalonia 规范绑定，服务抽象统一（IWindowService），Mini 模式以 Service 管理生命周期。
- 主要改进方向：
  - DB 迁移策略与数据文件路径规范（避免潜在数据损坏/增长）。
  - 资源释放/生命周期（定时器、流、通知/托盘 Manager 等）。
  - 插件加载的隔离与可靠性（版本冲突/依赖解析/Unload）。
  - 交互一致性与边界条件（迷你模式触发、靠边隐藏、多屏下角落逻辑）。
  - 基础工程化（日志、最小测试、打包与配置）。


二、架构 & 分层（P1）
- 现状：
  - MVVM 基本遵循；少量交互逻辑在 View code-behind（例如 MiniBallWindow、CircularLauncherView）可接受，但存在业务/交互与视图耦合。
  - Services 抽象良好（AutoHide/TopMost/AutoStartup 同一接口），MiniMode 独立管理窗口切换。
- 建议：
  - 将与交互状态相关的可测试逻辑（如长按触发、拖动状态机）抽出到独立可测试类或服务，View 仅转发事件。（P1）
  - 对 Services 引入 IDisposable 约束，集中释放资源；MainWindow 退出时统一 Dispose。（P1）
  - 为 PluginLoader 定义契约层（接口、DTO、异常约定），将“发现/加载/实例化/错误处理/隔离”清晰分层。（P1）


三、代码质量（P0/P1）
- 统一性：命名、可空注解、异常处理较为一致；少量 TODO/注释中文良好。
- 需要关注：
  - MiniBallWindow 与 CircularLauncherView 都有触发项的 PointerReleased 处理，存在重复/双触发风险。（P0）
  - IconService.ImageFromBytes 使用 MemoryStream 未显式释放；Avalonia Bitmap 一般会读取流后不依赖外部流，建议 using 保障释放。（P1）
  - AutoHideService 使用 Timer 未实现 Dispose；建议释放定时器与反订阅事件，防止潜在泄漏。（P1）
- 建议示例：
  - 在 CircularLauncherView 的 DataTemplate 已绑定 PointerReleased=Item_PointerReleased，MiniBallWindow.TryTriggerItemUnderPointer 可以改为兜底策略，避免与子项重复触发；或改为命中检测仅在 LauncherView 捕获不到事件时使用，并显式标记 e.Handled。（P0）
  - IconService.ImageFromBytes：
    ```csharp
    public static IImage? ImageFromBytes(byte[]? data)
    {
        if (data == null || data.Length == 0) return null;
        using var stream = new MemoryStream(data, writable: false);
        return new Avalonia.Media.Imaging.Bitmap(stream);
    }
    ```
  - AutoHideService/TopMostService/AutoStartupService/MiniModeService 实现 IDisposable；MainWindow 关闭时统一 Dispose。（P1）


四、性能与资源（P1）
- AutoHideService：
  - 两个 Timer + Dispatcher，频率合适（100ms 轮询）；但应在禁用时停止并释放；在窗口关闭时亦需释放。（P1）
- Icon 加载：
  - 从 exe 提取图标并保存为 PNG 字节，正常；但注意大图标或短时间多次添加应用时的 IO 压力。（P2）
- 布局计算：
  - CircularLauncherView 在 LayoutUpdated 中计算位置，ItemSize 固定；在 count 较大时建议节流/只在必要时重算。（P2）


五、跨平台/Win 特性（P1）
- 现状：许多功能仅在 Windows 有意义（托盘、通知、AutoStartup、System.Drawing、P/Invoke）。有良好 OS 检测（如鼠标位置）。
- 建议：
  - 在非 Windows 下优雅降级：隐藏相关 UI，或禁用命令并提示。（P1）
  - System.Drawing.Common 在非 Windows 平台可能不受支持，当前 csproj 定位 net8.0-windows 已规避。（P1）


六、UI/UX（P1）
- 现状：
  - 主窗体自定义标题栏、托盘交互合理；设置页组织良好；迷你模式的圆形启动器有动态边缘自适应。
- 改进：
  - Launcher 布局步进：当前 step = sweep/count 将不会覆盖终止角，通常 OK；若意图“首尾均匀覆盖”，可用 step = sweep/(count-1)（count>1）或增加边距参数。（P2）
  - 高 DPI/多显示器：靠边/角落判定 margin 需要对比窗口大小，防误判；建议将 margin 与窗口尺寸关联或可配置。（P1）
  - 无障碍：控件可聚焦、键盘导航、ARIA/AutomationPeers（后续）。（P2）


七、数据与持久化（P0）
- 现状：
  - SQLite-Net 直连，DBContext 在静态构造中 CreateTable 并尝试通过遍历列执行 ALTER TABLE 以“迁移”。
- 风险：
  - 对 SettingDB 逐列执行 ALTER TABLE 可能与 SQLite-Net 的映射类型不完全匹配，且会在列已存在时报错（虽被 catch 忽略），但长期演进可能引入隐蔽问题。（P0）
  - 数据文件路径使用 AppConfig.CONFIG_FOLDER 下的 "gamehub"（无扩展名）。不带扩展名不影响 SQLite，但不利于识别与管理。（P1）
- 建议：
  - 显式数据库文件名：例如 CONFIG_FOLDER/"microdock.db"。（P1）
  - 更稳健的迁移方式：
    - 方案 A：仅 CreateTable + 版本号迁移脚本（记录 schema 版本）。
    - 方案 B：查询 PRAGMA table_info 校验列是否存在后再 ALTER（避免无谓异常）。
    - 方案 C：采用轻量迁移库或在 SQLite-Net 基础上封装 MigrationHelper。（P0）


八、插件机制（P1）
- 现状：
  - 从 Plugins 目录扫描 dll，Assembly.LoadFrom 后反射 IMicroTab/IMicroActionsProvider，实例化并加入 UI。
- 风险与建议：
  - 隔离性：同进程加载，Avalonia/依赖版本冲突风险；建议引入 AssemblyLoadContext 自定义上下文，提供基础 API，必要时支持卸载。（P1）
  - 错误可观测：加载失败仅 Console.WriteLine，建议结构化日志并反馈到 UI（插件中心页）。（P1）
  - 安全：仅加载签名/白名单来源或提供用户确认提示；对动作执行提供权限边界与异常隔离。（P2）


九、可观测性与日志（P1）
- 建议：
  - 引入简易日志接口（ILogger）与实现（控制台/文件），统一记录服务状态、插件加载、DB 操作异常、用户动作等。（P1）
  - 重要路径（托盘、迷你模式切换、AutoHide 显隐）加上调试日志有助问题定位。（P1）


十、测试与构建（P1/P2）
- 现状：
  - 仓库含 Test 项，但未见具体用例；UI 层难测，但 Services/数据库/插件加载可单测。
- 建议：
  - 为 DBContext、IconService、PluginLoader 编写最小单测（路径选择、异常分支、基础行为）。（P1）
  - 为 AutoHideService 的边缘判定与状态机编写纯逻辑单测（抽象位置与矩形）。（P1）
  - CI：添加 GitHub Actions（构建+单测），可选发布 Artifact。（P2）


十一、文档与发布（P1）
- README 极简，建议：
  - 增加特性列表、截图/GIF、系统要求、安装与启动、快捷操作（托盘/迷你模式）说明、已知问题与路线图。（P1）
  - 添加“评估报告”链接与“贡献指南”（后续）。（P2）


十二、优先级梳理
- P0（建议尽快）：
  - 修正迷你启动器可能的双触发风险（统一触发路径，避免重复调用 OnTrigger）。
  - 调整/替换 DB 迁移策略（避免盲目 ALTER TABLE）。
- P1（近期）：
  - 为 AutoHideService/其他服务实现 IDisposable；主窗体退出释放资源。
  - IconService 内存流 using 释放。
  - 插件加载错误与日志改进；非 Windows 下功能降级与 UI 提示。
  - README 充实（使用指南/特性/截图）。
- P2（中长期）：
  - 插件隔离（AssemblyLoadContext）与卸载。
  - 布局/交互细节抛光、可访问性与国际化（多语言资源）。
  - 引入最小 CI/CD 与基础单测覆盖。


十三、“快速收益”清单（可在1-2个小迭代内完成）
- 代码：
  - 为 IconService.ImageFromBytes 与 IconService.TryExtractFileIconBytes 的流/图标对象添加 using 释放。（微改，影响面小）
  - AutoHideService 实现 IDisposable，Stop/Dispose 计时器，窗口关闭时调用。（微改）
  - MiniBallWindow 与 CircularLauncherView 统一点击触发路径，去除重复命中检测或在命中检查时设置 e.Handled。（小改）
- 数据：
  - DB 文件改名为 microdock.db；迁移逻辑改“先检查列存在再 ALTER”。（小改）
- 文档：
  - 充实 README，并在其中链接本评估报告。（小改）


附：可能的代码改动示意（仅示例）
- AutoHideService：
  ```csharp
  public sealed class AutoHideService : IWindowService, IDisposable
  {
      public void Dispose()
      {
          _window.PositionChanged -= OnWindowPositionChanged;
          _hideTimer?.Stop();
          _hideTimer?.Dispose();
          _showCheckTimer?.Stop();
          _showCheckTimer?.Dispose();
      }
  }
  ```
- MiniBallWindow/CircularLauncherView：将触发集中到 Item_PointerReleased，并在窗口级 PointerReleased 时仅在未被子项处理时兜底触发，或移除窗口级触发遍历。
- DBContext：将 "gamehub" 改为 "microdock.db"，并通过 `PRAGMA table_info(SettingDB)` 判断列是否存在再执行 ALTER。

以上为当前阶段的评估与建议，欢迎指出你最关心的改进方向，我可按优先级拆分任务并逐项落地实现。