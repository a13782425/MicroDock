# 环形菜单改造方案（P0/P1）

本文在“迷你启动器修改方案”的基础上，聚焦环形菜单（CircularLauncherView）与 MiniBallWindow 的一体化改造，给出无偏移的展开/收起策略，并新增“树枝状辐射（二级）菜单”的设计与最小实现计划。目标是在不破坏现有使用体验的前提下，完成 P0 最小可用改造，并为 P1 迭代打下基础。

---

## 1. 背景与目标

- 现状问题
  - 不同 DPI 下，MiniBallWindow 从 64×64 收起/展开为环形菜单时，中心点会出现轻微偏移（已通过“按像素中心缩放”在代码层面规避大部分场景）。
  - 二级菜单需求（树枝状辐射）尚未支持。
  - 图标来源多样（内置 PNG、插件字节流、系统应用提取），需要统一加载与显示策略。

- 改造目标
  - P0：
    - 彻底消除展开/收起过程中的中心漂移（DPI 安全）。
    - 在保留 CircularLauncherView 的前提下，支持“二级树枝状辐射菜单”的最小能力（仅展开二级、随一层 hover 切换，移开即收起）。
    - 提供基础动画与清晰的命中逻辑，防止双触发与误触。
  - P1：
    - 完善二级菜单的几何、美学与动画（入场/退场、弹性、遮罩、安全通道）。
    - 参数可配置化，支持个性化半径、扇形角度、阈值与延时。
    - 更完备的键鼠与无障碍支持。

---

## 2. 架构与取舍

- 继续保留 CircularLauncherView 作为“第一层环形”的渲染/布局与数据绑定容器：
  - 成熟稳定，可复用现有 Apps 与 Custom Items 的模板与命中测试。
  - MiniBallWindow 负责生命周期（长按展开、抬起触发、Esc 关闭）与 DPI 安全缩放，以及宿主窗口的动画过渡。
- 二级“树枝状辐射”菜单采用“同一窗口内额外层”的思路：
  - 不新开子窗口，避免 DPI 与输入焦点带来的额外复杂度。
  - 由一个轻量级 Panel（例如 OverlayCanvas或AdornerLayer）承载二级项，锚定第一层被 hover 的项中心，沿外侧向外射出若干按钮。

---

## 3. 无偏移策略（DPI 安全）

- 原因：不同缩放下 DIP 与像素转换造成的舍入误差会导致中心点在扩大/缩小时漂移。
- 策略：
  - 展开前记录窗口像素中心（PixelPoint）。
  - 调整大小时，使用 RenderScaling 将新的 DIP 尺寸换算为像素，基于“固定像素中心”倒推新的 Position。
  - 收起时同理，优先使用“展开前记录的像素中心”回到 64×64，避免累计误差。
- 当前实现（已完成）：
  - MiniBallWindow.ResizeWindowKeepingCenter / ResizeWindowAroundCenterPx。
  - 展开与收起全链路使用上述方法。

---

## 4. 二级菜单：树枝状辐射（设计）

- 触发模型
  - 鼠标长按展开第一层环形菜单。
  - 鼠标悬停到某个第一层项，若其存在子项，则在该项的外侧沿法线方向弹出若干二级按钮（线性或轻微弧形）。
  - 鼠标离开第一层项或滑入其他第一层项时，原二级菜单淡出并在新的锚点淡入。
  - 鼠标从第一层项“顺滑地”滑入其二级菜单区域时，不触发收起（通过“安全通道”多边形判断）。

- 几何布局（默认 P0）
  - 第一层：按 CircularLauncherView 既定几何布局（StartAngle、SweepAngle、Radius、ItemSize）。
  - 第二层：
    - 起点：第一层被 hover 项的几何中心（或外侧边的中心点）。
    - 方向：从中心指向该项的径向外侧（与圆心连线方向一致）。
    - 排列：N 个按钮沿该方向均匀排布，间距 itemGapPx，最大长度 secondRadiusPx。
    - 可选呈弧：在径向外再给定一个微小扇形角度（±12°）分散二级项，避免遮挡。

- 命中与安全通道
  - 第一层项与其二级区域之间构造一条“安全通道”（多边形），指针在通道内移动不判定为“离开”。
  - 二级项有独立命中区域，点击触发后可配置是否自动收起。
  - 统一事件处理：子项点击 e.Handled = true，避免父级重复触发。

- 动画（P0 最小）
  - 二级项淡入/淡出（150ms）。
  - 悬停第一层项高亮（缩放 1.08 或描边）。

- 键盘与可达性（P1）
  - 焦点在第一层项时，用方向键可打开/切换二级区域；Tab 在二级项间移动。

---

## 5. 数据与接口

- 第一层：延续 Applications 与 CustomItems 的 ItemViewModel（含图标、标题、动作）。
- 第二层：为每个第一层项扩展可选的 Children 列表：
  - 字段：Id、Title、Icon、Command/Callback、Arguments（可选）。
  - 数据来源：
    - 配置中声明二级项。
    - 插件提供的复合动作（可为某个第一层项挂载子动作集）。
- Icon 策略：
  - 内置 PNG：avares://MicroDock/Assets/Icon/xxx.png
  - 插件：IconService.ImageFromBytes
  - 系统文件：IconService.TryExtractFileIconBytes（P1 可扩展缓存与异步加载）。

---

## 6. 参数与默认值（建议）

- 第一层（已有）：
  - MiniRadius: 60
  - MiniItemSize: 40
  - MiniStartAngle: -90
  - MiniSweepAngle: 180
  - MiniAutoDynamicArc: true

- 第二层（新增，P0 生效；P1 可改成可视化配置）：
  - SecondLevelEnabled: true
  - SecondItemSize: 32 px
  - SecondItemGap: 10 px
  - SecondMaxCountPerNode: 6（超出滚动或分页，P1）
  - SecondSpawnRadius: 第一层项外侧 24 px 起始，向外最多 120 px
  - HoverDelayMs: 120（悬停在第一层项多长时间后出现二级）
  - AutoCollapseOnTrigger: true（触发后自动收起整体）

---

## 7. P0 实施清单

1) 窗口与 DPI
- 继续使用已实现的“像素中心缩放”避免偏移。✓ 现有实现可复用

2) 结构
- 保留 CircularLauncherView，增加一个 Overlay 层（例如在 MiniBallWindow.axaml 中在 LauncherView 之上添加一个透明 Canvas）。
- Overlay 负责绘制/承载二级项按钮，绑定当前 hover 的第一层项并计算锚点与方向。 

3) 交互
- 第一层项 PointerEnter/PointerLeave 事件：
  - 延时 HoverDelayMs 后显示 Overlay 的二级项集合。
  - PointerLeave 若不在“安全通道”内并且未进入 Overlay 区域，则隐藏二级项。
- 二级项点击：执行回调；若 AutoCollapseOnTrigger 则调用 ResetToBall。

4) 动画
- Overlay 的二级项淡入/淡出（Opacity 动画，150ms）。

5) 图标与资源
- 优先显示项自带的 IImage；若仅有 Path 则通过 IconService 取图；
- 插件字节流走 ImageFromBytes；
- 若全部失败，显示默认占位符（内置 PNG）。

6) 测试用内置图标
- Assets/Icon 目录下的 PNG 用于 P0 展示与命中测试：
  - FloatBall.png、Test.png 等，确保打包资源可访问。

---

## 8. P1 迭代项

- 安全通道从线性通道升级为多边形插值，贴合实际路径。
- 二级项呈轻微圆弧排布，支持顺/逆时针对齐与碰撞规避（靠屏幕边缘自动折线/折弧）。
- 添加悬浮跟随动画与磁吸微动效。
- 配置 UI（SettingsTab）：图形化参数调整与实时预览。
- 异步图标加载与缓存，避免主线程卡顿。
- 键盘可达性与 Narrator 文本。

---

## 9. 风险与回退

- 风险
  - DPI 与 Position 的边界组合仍可能在特定 GPU/驱动下出现 1px 抖动。
  - Overlay 命中与第一层命中的事件冲突，需要严格 e.Handled 与命中优先级。
  - 插件返回的图标字节流格式不规范可能导致解码异常。
- 回退
  - 可通过设置 SecondLevelEnabled=false 完全关闭二级功能，回到纯环形菜单。
  - 保留既有 CircularLauncherView 行为，不修改原有触发/收起主路径。

---

## 10. 验收与测试用例（手测）

- 无偏移：
  - 在 100%/125%/150% 缩放下，记录展开/收起前后的窗口中心像素；允许±0px 偏移。
- 悬停切换：
  - 一层 hover 到 A，显示 A 的二级；移到 B，A 的二级淡出，B 的二级在新锚点淡入。
- 安全通道：
  - 从 A 项沿径向直线移入 A 的二级项，不触发收起；从非通道区域离开则收起。
- 触发与收起：
  - 点击二级项后，动作执行，整体自动收起（AutoCollapseOnTrigger=true）。
- 图标：
  - 验证内置 PNG、插件字节流、系统提取三种来源均能正确显示。

---

## 11. 下一步

- 如无异议，按本文 P0 实施：
  - 在 MiniBallWindow 中新增 Overlay 层与最小二级渲染；
  - 为 CircularLauncherView 的第一层项挂钩 PointerEnter/Leave；
  - 引入简单的二级数据结构与绑定；
  - 添加基本淡入/淡出动画与命中逻辑；
  - 用 Assets/Icon 中现有 PNG 做演示与测试。

如需更改默认参数或 UI 表现，请在合并 P0 前反馈，我们将同步调整。

---

附：更多关于“全屏透明宿主窗口”的交互与性能 FAQ
- 请参见 docs/迷你模式-全屏透明窗口可行性与设计.md 中的章节《FAQ：全屏透明窗口会不会影响透明区域的操作？渲染效率如何？》。
