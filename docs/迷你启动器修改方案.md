# 迷你启动器（悬浮球 + 环形启动器）修改方案

最后更新：2025-10-16

本文聚焦“迷你启动器（Mini 模式）”的交互与技术改造方案，目标是在保持现有代码结构与使用体验的前提下，做最小化改动获得稳定与体验的明显提升，并规划后续渐进增强路线。


一、目标与范围
- 目标：
  - 提升触发稳定性，杜绝重复/误触发。
  - 优化展开/收起逻辑与边缘自适应，适配多屏与高 DPI。
  - 引入基础的可配置项（半径、角度、长按阈值等），支持后续扩展。
  - 为后续动画、可访问性与插件动作集成预留接口。
- 范围：仅涉及 MiniBallWindow 与 CircularLauncherView 及关联 Service 的轻量调整；不改变主窗口与数据模型的总体结构。


二、现状问题（Pain Points）
- 触发路径可能重复：
  - CircularLauncherView 的每个子项在 PointerReleased 中触发 OnTrigger；
  - MiniBallWindow 在展开状态下，OnPointerReleased 里做命中检测并触发；
  - 在部分路由/命中情况下可能导致双触发（取决于命中与事件处理标记）。
- 交互一致性：
  - 展开/收起缺少显式反馈（动画/光标变化）；
  - 点击空白处与 Esc 的行为未统一文档化；
  - 长按拖动与点击展开的判定阈值/时序边界待抛光。
- 布局与边缘自适应：
  - 动态“半环方向”已实现，但边缘判定 margin 固定值，未关联窗口尺寸；
  - 等分算法 step = sweep/count，首尾不覆盖终止角，可能存在视觉不均（非严格问题）。
- 可配置性与可测试性：
  - 长按阈值、半径、角度、项大小、是否触发后自动收起等不可配置；
  - 交互状态逻辑分散在 View 代码中，难于单测。


三、P0 改动（本次最小交付）
- 统一触发路径，避免双触发：
  - 在 CircularLauncherView.Item_PointerReleased 末尾设置 e.Handled = true，防止事件冒泡到父级兜底命中检测（已完成）。
  - MiniBallWindow 的 TryTriggerItemUnderPointer 保留作为兜底策略，但应只在点击发生于非子项区域时才依赖（当前结构下已天然只绑定在“球体”元素上，不会与子项重复；如后续变更到 Window 级事件需注意 e.Handled 判断）。
- 明确收起行为：
  - 保持现有：点击项后立即执行 OnTrigger，同时由 MiniBallWindow 在释放后收回为球体；
  - 保留 Esc 键收起（已有）。
- 文档化交互：
  - 本文作为“行为规范”，约定：
    - 按下并保持 ≥500ms：进入拖动模式；
    - 短按释放：切换展开/收起或执行点击项；
    - 展开后点击空白：收起；
    - 按 Esc：收起。

注：本次提交已完成“事件统一”的关键修复（设置 e.Handled = true），属于无破坏式小改。


四、P1 渐进增强（近期迭代）
- 交互与动画：
  - 展开/收起淡入淡出 + 半径插值动画；
  - 点击项后可选“执行后自动收起/保持展开”的配置项。
- 可配置项（SettingDB + UI）：
  - LongPressMs（默认 500ms）、Radius、ItemSize、StartAngle、SweepAngle、AutoDynamicArc（是否根据边缘自动半环）；
  - EdgeMargin 与窗口尺寸关联：edgeMargin = max(32, min(64, min(Width, Height) * 0.75)).
- 结构与可测试性：
  - 抽取 MiniInteractionController（纯逻辑）：
    - 状态：Idle/Pressing/Dragging/Expanded；
    - 事件：PointerDown/Move/Up/Timeout/Escape；
    - 输出：是否进入拖动、是否展开/收起。
  - View 层仅转发事件，Controller 可做单元测试。
- 多屏/高 DPI：
  - 统一通过 Screens.ScreenFromWindow/Point 获取 WorkingArea，确保在 DPI 缩放下判定准确；
  - 增加“靠近角落”的特别布局（四象限弧线）。


五、P2 中长期优化
- 可访问性：
  - 子项可聚焦，键盘左右切换，Enter 触发；屏幕阅读器名称/提示；
  - 高对比度适配。
- 插件动作整合：
  - 将 IMicroActionsProvider 的动作映射为 ILauncherItem（已部分具备），提供分组与图标策略；
  - 动作权限与失败反馈（Toast/日志）。
- 架构与工程化：
  - 引入简单 ILogger，记录展开/收起、触发、错误；
  - 最小单测：布局计算（给定 count/半径/角度输出坐标）、交互状态机。


六、具体改动清单与代码要点
- 已完成（P0）：
  - 防止双触发：在 CircularLauncherView.Item_PointerReleased 设置 e.Handled = true。
    
    代码（节选）：
    
    // CircularLauncherView.axaml.cs
    private void Item_PointerReleased(object? sender, PointerReleasedEventArgs e)
    {
        var element = sender as Control;
        if (element == null) return;
        var item = element.DataContext as ILauncherItem;
        if (item == null) return;
        item.OnTrigger?.Invoke();
        e.Handled = true; // 关键：阻止冒泡，避免父级兜底再次触发
    }

- 建议变更（P1）：
  - 将 MiniBallWindow 中与长按/拖动/展开的判定，迁移到 MiniInteractionController；
  - CircularLauncherView 的布局步进改为：step = count > 1 ? sweep/(count-1) : 0，并增加首/尾边距选项；
  - 通过 SettingDB 增加 Mini 配置项，并在 SettingsTab 暴露 UI 调整。


七、验收标准（Acceptance Criteria）
- 触发一致性：点击任一启动项仅触发一次动作，调试日志中无重复执行记录；
- 展开/收起：
  - 短按展开，短按空白收起；
  - Esc 收起有效；
  - 长按 ≥500ms 进入拖动，拖动不触发展开；
- 边缘自适应：窗口靠近左右/上下边缘时，弧线方向正确，无明显越界；
- 基础配置：默认参数下体验平衡，无明显误触；
- 稳定性：多次切换 Mini 模式、在多屏环境下操作不崩溃。


八、风险与回退
- 事件路由差异：不同 Avalonia 版本对 Pointer 事件路由行为略有差别；已通过设置 Handled 降低风险。
- 如出现“点击无反应/不收起”，可快速回退到此前版本；本次改动小、冲突面极低。


九、后续工作排期（建议）
- S1（当天内）：合并 P0 修复（已完成），联调与基本手测；
- S2（1-2 天）：实现可选的“执行后保持展开”开关、展开/收起的基础动画；
- S3（1 周内）：抽取 MiniInteractionController，并为其与布局逻辑补最小单测；
- S4（2 周内）：多屏/高 DPI 抛光、可访问性基础支持、插件动作整合 UX。
