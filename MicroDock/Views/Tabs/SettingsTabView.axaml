<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:vm="using:MicroDock.ViewModel"
			 xmlns:models="using:MicroDock.Model"
			 xmlns:plugin="using:MicroDock.Plugin"
			 xmlns:db="using:MicroDock.Database"
			 xmlns:fa="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
			 xmlns:controls="using:MicroDock.Views.Controls"
			 mc:Ignorable="d"
			 d:DesignWidth="500"
			 d:DesignHeight="350"
			 x:Class="MicroDock.Views.SettingsTabView"
			 x:DataType="vm:SettingsTabViewModel"
             x:Name="Root">
	<Design.DataContext>
		<vm:SettingsTabViewModel />
	</Design.DataContext>
	<UserControl.Styles>

	</UserControl.Styles>
	<ScrollViewer HorizontalScrollBarVisibility="Disabled"
				  VerticalScrollBarVisibility="Auto">
		<StackPanel Margin="0,12,12,12" Spacing="8">
			<!-- 基础设置分组 -->
			<fa:SettingsExpander Header="基础设置"
								 IconSource="Setting"
								 IsExpanded="False">
				<StackPanel Margin="10,10,10,10">
					<Grid Margin="0,4">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBlock Text="开机自启动"
								   VerticalAlignment="Center"
								   Grid.Column="0"/>
						<ToggleSwitch IsChecked="{Binding AutoStartup, Mode=TwoWay}"
									  Grid.Column="1"
									  OnContent=""
									  OffContent=""/>
					</Grid>

					<Grid Margin="0,4">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBlock Text="靠边隐藏"
								   VerticalAlignment="Center"
								   Grid.Column="0"/>
						<ToggleSwitch IsChecked="{Binding AutoHide, Mode=TwoWay}"
									  Grid.Column="1"
									  OnContent=""
									  OffContent=""/>
					</Grid>

					<Grid Margin="0,4">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBlock Text="窗口置顶"
								   VerticalAlignment="Center"
								   Grid.Column="0"/>
						<ToggleSwitch IsChecked="{Binding AlwaysOnTop, Mode=TwoWay}"
									  Grid.Column="1"
									  OnContent=""
									  OffContent=""/>
					</Grid>

					<!-- 主题设置 -->
					<Grid Margin="0,4">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="200"/>
						</Grid.ColumnDefinitions>
						<TextBlock Text="主题"
								   VerticalAlignment="Center"
								   Grid.Column="0"/>
						<controls:GroupedComboBox Grid.Column="1"
												  GroupedItemsSource="{Binding GroupedThemes}"
												  SelectedItem="{Binding SelectedThemeModel, Mode=TwoWay}"
												  DisplayMemberPath="DisplayName"
												  PlaceholderText="选择主题..."
												  IsGroupCollapsible="False"
												  MaxDropDownHeight="300">
							<controls:GroupedComboBox.ItemTemplate>
								<DataTemplate DataType="models:ThemeModel">
									<TextBlock Text="{Binding DisplayName}"
											   FontSize="13"/>
								</DataTemplate>
							</controls:GroupedComboBox.ItemTemplate>
						</controls:GroupedComboBox>
					</Grid>
				</StackPanel>
			</fa:SettingsExpander>

			<!-- 页签管理分组 -->
			<fa:SettingsExpander Header="页签管理"
								 IconSource="Library"
								 IsExpanded="True">
				<StackPanel Margin="10">
                    <TextBlock Text="导航栏顺序与快捷键" FontWeight="SemiBold" Margin="0,0,0,8"/>
					<ItemsControl ItemsSource="{Binding NavigationTabs}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<StackPanel />
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
						<ItemsControl.ItemTemplate>
							<DataTemplate DataType="vm:NavigationTabSettingItem">
								<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
										BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
										BorderThickness="1"
										CornerRadius="4"
										Padding="8"
										Margin="0,4"
										DragDrop.AllowDrop="True"
										PointerPressed="NavigationItem_PointerPressed"
										DragDrop.DragOver="NavigationItem_DragOver"
										DragDrop.Drop="NavigationItem_Drop">
									<Grid Background="Transparent">
										<Grid.ColumnDefinitions>
											<ColumnDefinition Width="Auto"/> <!-- IsVisible -->
											<ColumnDefinition Width="*"/>    <!-- Name -->
											<ColumnDefinition Width="Auto"/> <!-- Drag Handle -->
										</Grid.ColumnDefinitions>
										
										<CheckBox IsChecked="{Binding IsVisible}" Grid.Column="0" Margin="0,0,12,0" ToolTip.Tip="是否显示"/>
										
										<StackPanel Grid.Column="1" VerticalAlignment="Center">
											 <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
											 <TextBlock Text="{Binding UniqueId}" FontSize="10" Foreground="Gray" TextTrimming="CharacterEllipsis"/>
										</StackPanel>
										
										<TextBlock Grid.Column="3" Text="≡" FontSize="16" VerticalAlignment="Center" Margin="8,0" 
												   Cursor="SizeAll" ToolTip.Tip="拖拽排序"/>
									</Grid>
								</Border>
							</DataTemplate>
						</ItemsControl.ItemTemplate>
					</ItemsControl>
                    
                    <TextBlock Text="提示: 设置全局快捷键后，按下组合键可快速打开对应标签页。" 
                               FontSize="11" Foreground="Gray" Margin="0,8,0,0" TextWrapping="Wrap"/>
				</StackPanel>
			</fa:SettingsExpander>

			<!-- 插件管理分组 -->
			<fa:SettingsExpander Header="插件管理"
								 IconSource="ViewAll"
								 Description="查看、导入和管理插件">
				<fa:SettingsExpander.Footer>
					<Button Content="导入插件"
							Command="{Binding ImportPluginCommand}"
							Classes="accent"/>
				</fa:SettingsExpander.Footer>
				<ItemsControl ItemsSource="{Binding PluginSettings}" Margin="0,0,0,0">
					<ItemsControl.ItemTemplate>
						<DataTemplate x:DataType="vm:PluginSettingItem">
							<fa:SettingsExpander Margin="0,4"
												 Description="{Binding StatusText}">
								<fa:SettingsExpander.Header>
									<StackPanel Orientation="Horizontal" Spacing="8">
										<TextBlock Text="{Binding PluginName}"
												   FontWeight="SemiBold"
												   VerticalAlignment="Center"/>
										<TextBlock Text="{Binding UniqueName}"
												   FontSize="11"
												   Foreground="Gray"
												   Cursor="Hand"
												   VerticalAlignment="Bottom"
												   PointerPressed="PluginUniqueName_PointerPressed"/>
										
										<!-- 待删除标记 -->
										<Border Background="Orange" CornerRadius="3" Padding="4,2" 
												IsVisible="{Binding IsPendingDelete}">
											<TextBlock Text="待删除" FontSize="10" Foreground="White"/>
										</Border>
										
										<!-- 待更新标记 -->
										<Border Background="DodgerBlue" CornerRadius="3" Padding="4,2" 
												IsVisible="{Binding IsPendingUpdate}">
											<TextBlock Text="{Binding PendingVersion, StringFormat='待更新至 v{0}'}" FontSize="10" Foreground="White"/>
										</Border>
									</StackPanel>
								</fa:SettingsExpander.Header>

								<fa:SettingsExpander.Footer>
									<StackPanel Orientation="Horizontal" Spacing="8">
										<!-- 启用/禁用开关（待删除或待更新时禁用） -->
										<ToggleSwitch IsChecked="{Binding IsEnabled, Mode=TwoWay}"
													  IsEnabled="{Binding !IsPendingDelete}"
													  OnContent="已启用"
													  OffContent="已禁用"/>
										
										<!-- 取消更新按钮（仅待更新时显示） -->
										<Button Content="取消更新"
												Command="{Binding CancelUpdateCommand}"
												IsVisible="{Binding IsPendingUpdate}"
												Classes="accent"/>
										
										<!-- 取消删除按钮（仅待删除时显示） -->
										<Button Content="取消删除"
												Command="{Binding CancelDeleteCommand}"
												IsVisible="{Binding IsPendingDelete}"
												Classes="accent"/>

										<!-- 删除按钮（待删除或待更新时隐藏） -->
										<Button Content="删除"
												Command="{Binding DeleteCommand}"
												IsVisible="{Binding !IsPendingDelete}"
												Classes="danger"/>
									</StackPanel>
								</fa:SettingsExpander.Footer>

								<StackPanel Margin="10,5" Spacing="8">
									<!-- 插件信息 -->
									<StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
										<TextBlock Text="安装时间："
												   FontSize="11"
												   Foreground="Gray"/>
										<TextBlock Text="{Binding InstalledAtText}"
												   FontSize="11"
												   Foreground="Gray"/>
										<TextBlock Text="·" FontSize="11" Foreground="Gray"/>
										<TextBlock Text="{Binding ToolCountText}"
												   FontSize="11"
												   Foreground="Gray"/>
									</StackPanel>
									<!-- 插件设置控件 -->
									<ContentControl Content="{Binding SettingsControl}"
													IsVisible="{Binding HasSettings}"/>

									<!-- 工具列表 -->
									<StackPanel IsVisible="{Binding HasTools}">
										<TextBlock Text="注册的工具："
												   FontWeight="SemiBold"
												   FontSize="12"
												   Margin="0,4,0,4"/>

										<ItemsControl ItemsSource="{Binding Tools}">
											<ItemsControl.ItemTemplate>
												<DataTemplate DataType="plugin:ToolInfo">
													<Border Background="{DynamicResource SubtleFillColorSecondaryBrush}"
															BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
															BorderThickness="1"
															Padding="10,6"
															CornerRadius="6"
															Margin="0,3">
														<StackPanel>
															<TextBlock Text="{Binding Name}"
																	   FontFamily="Consolas"
																	   FontSize="12"
																	   FontWeight="SemiBold"
																	   Foreground="{DynamicResource TextFillColorPrimaryBrush}"
																	   Cursor="Hand"
																	   PointerPressed="ToolName_PointerPressed"/>

															<!-- 工具提示显示详细信息 -->
															<ToolTip.Tip>
																<StackPanel MaxWidth="360" Spacing="8">
																	<!-- 警告：首次调用创建实例 -->
																	<Border Background="#40FFA500"
																			BorderBrush="Orange"
																			BorderThickness="1"
																			CornerRadius="4"
																			Padding="8,4"
																			IsVisible="{Binding NeedsLazyInstance}">
																		<StackPanel Orientation="Horizontal" Spacing="6">
																			<TextBlock Text="⚠️" FontSize="12"/>
																			<TextBlock Text="首次调用创建实例，后续复用"
																					   Foreground="Orange"
																					   FontSize="11"
																					   FontWeight="SemiBold"/>
																		</StackPanel>
																	</Border>
																	<!-- 描述 -->
																	<TextBlock Text="{Binding Description}"
																			   FontWeight="Bold"
																			   TextWrapping="Wrap"
																			   IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

																	<!-- 返回值 -->
																	<StackPanel IsVisible="{Binding ReturnDescription, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
																		<TextBlock Text="返回值："
																				   FontWeight="SemiBold"
																				   FontSize="11"/>
																		<TextBlock Text="{Binding ReturnDescription}"
																				   TextWrapping="Wrap"
																				   FontSize="11"
																				   Margin="0,2,0,0"/>
																	</StackPanel>

																	<!-- 参数列表 -->
																	<StackPanel IsVisible="{Binding !!Parameters.Count}">
																		<TextBlock Text="参数："
																				   FontWeight="SemiBold"
																				   FontSize="11"/>
																		<ItemsControl ItemsSource="{Binding Parameters}" Margin="0,2,0,0">
																			<ItemsControl.ItemTemplate>
																				<DataTemplate>
																					<StackPanel Orientation="Horizontal"
																								Spacing="4"
																								Margin="0,1">
																						<TextBlock Text="{Binding Name}"
																								   FontFamily="Consolas"
																								   FontSize="10"
																								   FontWeight="SemiBold"/>
																						<TextBlock Text=":"
																								   FontSize="10"/>
																						<TextBlock Text="{Binding TypeName}"
																								   Foreground="Gray"
																								   FontSize="10"/>
																						<TextBlock Text="-"
																								   FontSize="10"
																								   IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
																						<TextBlock Text="{Binding Description}"
																								   TextWrapping="Wrap"
																								   FontSize="10"
																								   IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
																						<TextBlock Text="(可选)"
																								   FontSize="10"
																								   Foreground="Orange"
																								   IsVisible="{Binding !Required}"/>
																					</StackPanel>
																				</DataTemplate>
																			</ItemsControl.ItemTemplate>
																		</ItemsControl>
																	</StackPanel>
																</StackPanel>
															</ToolTip.Tip>
														</StackPanel>
													</Border>
												</DataTemplate>
											</ItemsControl.ItemTemplate>
										</ItemsControl>
									</StackPanel>

									<!-- 无工具提示 -->
									<TextBlock Text="（该插件未注册任何工具）"
											   Foreground="Gray"
											   FontSize="11"
											   IsVisible="{Binding !HasTools}"/>
								</StackPanel>
							</fa:SettingsExpander>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</fa:SettingsExpander>

			<!-- 高级设置分组 -->
			<fa:SettingsExpander Header="高级设置"
								 IconSource="Code">
				<StackPanel Margin="10,10,0,10">
					<!-- 显示日志查看器选项 -->
					<Grid Margin="0,4">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBlock Text="显示日志查看器"
								   VerticalAlignment="Center"
								   Grid.Column="0"/>
						<ToggleSwitch IsChecked="{Binding ShowLogViewer, Mode=TwoWay}"
									  Grid.Column="1"
									  OnContent=""
									  OffContent=""/>
					</Grid>

					<TextBlock Text="性能优化"
							   FontSize="13"
							   FontWeight="SemiBold"
							   Margin="0,15,0,8"
							   Foreground="#666"/>
					<TextBlock Text="高级配置功能待实现..."
							   Foreground="Gray"
							   FontSize="12"
							   Margin="0,4"/>

					<TextBlock Text="调试选项"
							   FontSize="13"
							   FontWeight="SemiBold"
							   Margin="0,15,0,8"
							   Foreground="#666"/>
					<TextBlock Text="调试工具待实现..."
							   Foreground="Gray"
							   FontSize="12"
							   Margin="0,4"/>
				</StackPanel>
			</fa:SettingsExpander>

			<!-- 关于信息 -->
			<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
					BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
					BorderThickness="1"
					CornerRadius="8"
					Padding="16"
					Margin="0,8,0,0"
					HorizontalAlignment="Stretch">
				<StackPanel Spacing="4">
					<TextBlock Text="关于 MicroDock"
							   FontSize="14"
							   FontWeight="SemiBold"/>
					<TextBlock Text="版本: 0.0.1.0"
							   FontSize="12"
							   Opacity="0.7"/>
					<TextBlock Text="轻量级桌面工具栏应用"
							   FontSize="12"
							   Opacity="0.7"/>
				</StackPanel>
			</Border>
		</StackPanel>
	</ScrollViewer>
</UserControl>

