<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:MicroNotePlugin.ViewModels"
             xmlns:local="clr-namespace:MicroNotePlugin.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="250" d:DesignHeight="450"
             x:Class="MicroNotePlugin.Views.Controls.FileTreeView"
             x:DataType="vm:FileTreeViewModel">

    <UserControl.Resources>
        <local:NodeIconConverter x:Key="NodeIconConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- æ ‘èŠ‚ç‚¹æ ·å¼ -->
        <Style Selector="TreeViewItem">
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
        </Style>
        
        <!-- æ–‡ä»¶èŠ‚ç‚¹æ‚¬åœæ•ˆæžœ -->
        <Style Selector="Border.node-border:pointerover">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListLowBrush}"/>
        </Style>
        
        <!-- æ”¶è—å›¾æ ‡æ ·å¼ -->
        <Style Selector="TextBlock.favorite-star">
            <Setter Property="Foreground" Value="#FFD700"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Margin" Value="4,0,0,0"/>
        </Style>

        <!-- ç¼–è¾‘æ¡†æ ·å¼ -->
        <Style Selector="TextBox.inline-edit">
            <Setter Property="MinWidth" Value="100"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- å·¥å…·æ  -->
        <Border Grid.Row="0" 
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                Padding="4">
            <StackPanel Orientation="Horizontal" Spacing="4">
                <Button x:Name="NewNoteButton" 
                        ToolTip.Tip="æ–°å»ºç¬”è®°"
                        Padding="6"
                        Background="Transparent">
                    <TextBlock Text="ðŸ“" FontSize="14"/>
                </Button>
                <Button x:Name="NewFolderButton" 
                        ToolTip.Tip="æ–°å»ºæ–‡ä»¶å¤¹"
                        Padding="6"
                        Background="Transparent">
                    <TextBlock Text="ðŸ“" FontSize="14"/>
                </Button>
                <Button x:Name="RefreshButton" 
                        ToolTip.Tip="åˆ·æ–°"
                        Padding="6"
                        Background="Transparent">
                    <TextBlock Text="ðŸ”„" FontSize="14"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- æœç´¢æ¡† -->
        <Border Grid.Row="1" Padding="4">
            <Grid ColumnDefinitions="*,Auto">
                <TextBox x:Name="SearchBox"
                         Grid.Column="0"
                         Watermark="ðŸ” æœç´¢ç¬”è®°..."
                         Text="{Binding SearchKeyword, Mode=TwoWay}"
                         Padding="8,6"/>
                <Button x:Name="ClearSearchButton"
                        Grid.Column="1"
                        ToolTip.Tip="æ¸…é™¤æœç´¢"
                        Padding="6"
                        Margin="4,0,0,0"
                        Background="Transparent"
                        IsVisible="{Binding SearchKeyword, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="âœ•" FontSize="12"/>
                </Button>
            </Grid>
        </Border>

        <!-- æ–‡ä»¶æ ‘ -->
        <TreeView Grid.Row="2" 
                  x:Name="FileTree"
                  ItemsSource="{Binding RootNodes}"
                  SelectedItem="{Binding SelectedNode, Mode=TwoWay}"
                  SelectionMode="Single"
                  Margin="0,4,0,0">
            <TreeView.ItemTemplate>
                <TreeDataTemplate ItemsSource="{Binding Children}">
                    <Border Classes="node-border" 
                            Padding="4,2" 
                            CornerRadius="4"
                            Background="Transparent">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="æ–°å»ºç¬”è®°"
                                          Command="{Binding #FileTree.DataContext.CreateNoteCommand}"
                                          CommandParameter="{Binding}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="ðŸ“"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="æ–°å»ºæ–‡ä»¶å¤¹"
                                          Command="{Binding #FileTree.DataContext.CreateFolderCommand}"
                                          CommandParameter="{Binding}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="ðŸ“"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <Separator/>
                                <MenuItem Header="æ”¶è—/å–æ¶ˆæ”¶è—"
                                          Command="{Binding #FileTree.DataContext.ToggleFavoriteCommand}"
                                          CommandParameter="{Binding}"
                                          IsVisible="{Binding IsFile}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="â­"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <Separator IsVisible="{Binding IsFile}"/>
                                <MenuItem Header="é‡å‘½å"
                                          Command="{Binding #FileTree.DataContext.StartRenameCommand}"
                                          CommandParameter="{Binding}"
                                          IsVisible="{Binding !IsRoot}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="âœï¸"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="åˆ é™¤"
                                          Command="{Binding #FileTree.DataContext.DeleteCommand}"
                                          CommandParameter="{Binding}"
                                          IsVisible="{Binding !IsRoot}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="ðŸ—‘ï¸"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </Border.ContextMenu>
                        
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <!-- å›¾æ ‡ -->
                            <TextBlock FontSize="14">
                                <TextBlock.Text>
                                    <MultiBinding Converter="{StaticResource NodeIconConverter}">
                                        <Binding Path="NodeType"/>
                                        <Binding Path="Name"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            
                            <!-- åç§°ï¼ˆéžç¼–è¾‘çŠ¶æ€ï¼‰ -->
                            <TextBlock Text="{Binding Name}" 
                                       VerticalAlignment="Center"
                                       FontWeight="{Binding IsRoot, Converter={x:Static local:BoolConverters.ToFontWeight}}"
                                       IsVisible="{Binding !IsEditing}"/>
                            
                            <!-- ç¼–è¾‘æ¡†ï¼ˆç¼–è¾‘çŠ¶æ€ï¼‰ -->
                            <TextBox x:Name="EditTextBox"
                                     Classes="inline-edit"
                                     Text="{Binding EditingName, Mode=TwoWay}"
                                     IsVisible="{Binding IsEditing}"
                                     VerticalAlignment="Center"/>
                            
                            <!-- æ”¶è—æ ‡è®° -->
                            <TextBlock Text="â­" 
                                       Classes="favorite-star"
                                       IsVisible="{Binding IsFavorite}"
                                       VerticalAlignment="Center"/>
                            
                            <!-- æ‰“å¼€æ¬¡æ•°ï¼ˆä»…å¸¸ç”¨èŠ‚ç‚¹ä¸‹æ˜¾ç¤ºï¼‰ -->
                            <TextBlock Text="{Binding OpenCount, StringFormat='({0})'}"
                                       FontSize="11"
                                       Opacity="0.6"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding OpenCount, Converter={x:Static local:ObjectConverters.IsGreaterThanZero}}"/>
                        </StackPanel>
                    </Border>
                </TreeDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>
    </Grid>
</UserControl>
