<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:md="clr-namespace:Markdown.Avalonia;assembly=Markdown.Avalonia"
			 xmlns:views="clr-namespace:AIChatPlugin.Views"
			 xmlns:models="clr-namespace:AIChatPlugin.Models"
			 x:Class="AIChatPlugin.Views.MessageBubble">
	<UserControl.Styles>
		<StyleInclude Source="/Styles/MarkdownStyles.axaml"/>
	</UserControl.Styles>

	<UserControl.Resources>
		<views:RoleToBackgroundConverter x:Key="RoleToBackgroundConverter"/>
		<views:RoleToAlignmentConverter x:Key="RoleToAlignmentConverter"/>
		<views:RoleToNameConverter x:Key="RoleToNameConverter"/>
		<views:IsAssistantRoleConverter x:Key="IsAssistantRoleConverter"/>
		<views:IsUserRoleConverter x:Key="IsUserRoleConverter"/>
		<views:StringToBoolConverter x:Key="StringToBoolConverter"/>
	</UserControl.Resources>

	<Border CornerRadius="8" Padding="12" Margin="0,0,0,12"
			Background="{Binding Role, Converter={StaticResource RoleToBackgroundConverter}}"
			HorizontalAlignment="{Binding Role, Converter={StaticResource RoleToAlignmentConverter}}">
		<StackPanel Spacing="8">
			<!-- è§’è‰²æ ‡è¯† -->
			<TextBlock Text="{Binding Role, Converter={StaticResource RoleToNameConverter}}"
					   FontSize="12" FontWeight="Bold" Opacity="0.7"/>

			<!-- æ¶ˆæ¯å†…å®¹ï¼šæ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒæŽ§ä»¶ -->
<!--
			<Grid>
				
			</Grid>-->

			<!-- ç”¨æˆ·æ¶ˆæ¯ï¼šæ™®é€šæ–‡æœ¬ -->
				<TextBlock Text="{Binding Content}"
						   TextWrapping="Wrap"
						   IsVisible="{Binding Role, Converter={StaticResource IsUserRoleConverter}}"/>
				<!-- Think Expander -->
				<Expander Header="ðŸ§  æ€è€ƒè¿‡ç¨‹" IsExpanded="False"
						  IsVisible="{Binding ThinkContent, Converter={StaticResource StringToBoolConverter}}"
						  Margin="0,0,0,8">
					<md:MarkdownScrollViewer Markdown="{Binding ThinkContent}"
											 MaxHeight="400"/>
				</Expander>
				<!-- AI æ¶ˆæ¯ï¼šMarkdown æ¸²æŸ“ -->
				<md:MarkdownScrollViewer Markdown="{Binding Content}"
										 MaxHeight="600"
										 IsVisible="{Binding Role, Converter={StaticResource IsAssistantRoleConverter}}"/>

			<!-- Mermaid å›¾ç‰‡ -->
			<Border CornerRadius="8" Padding="8" Margin="0,0,0,8"
					Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
					BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
					BorderThickness="1"
					IsVisible="{Binding MermaidImage, Converter={x:Static ObjectConverters.IsNotNull}}">
				<StackPanel Spacing="8">
					<!-- å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
					<Image Source="{Binding MermaidImage}"
						   MaxHeight="400"
						   Stretch="Uniform"
						   HorizontalAlignment="Center"/>

					<!-- æ“ä½œæŒ‰é’® -->
					<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
						<Button Content="ðŸ“‹ å¤åˆ¶ä»£ç "
								Padding="8,4"
								Click="OnCopyMermaidCode"
								VerticalAlignment="Center"/>
						<Button Content="ðŸ” æŸ¥çœ‹å¤§å›¾"
								Padding="8,4"
								Click="OnViewFullMermaid"
								VerticalAlignment="Center"/>
					</StackPanel>
				</StackPanel>
			</Border>

			<!-- Mermaid åŠ è½½ä¸­æŒ‡ç¤ºå™¨ -->
			<Border CornerRadius="8" Padding="12" Margin="0,0,0,8"
					Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
					IsVisible="{Binding IsMermaidLoading}">
				<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
					<TextBlock Text="â³" FontSize="16"/>
					<TextBlock Text="æ­£åœ¨ç”Ÿæˆå›¾è¡¨..." FontSize="12" Opacity="0.7"/>
				</StackPanel>
			</Border>

			<!-- æµå¼æŒ‡ç¤ºå™¨ -->
			<TextBlock Text="æ­£åœ¨è¾“å…¥..."
					   IsVisible="{Binding IsStreaming}"
					   FontSize="12" Opacity="0.6" FontStyle="Italic"/>

			<!-- æ—¶é—´æˆ³ -->
			<TextBlock Text="{Binding Timestamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"
					   FontSize="10" Opacity="0.5"/>
		</StackPanel>
	</Border>
</UserControl>

