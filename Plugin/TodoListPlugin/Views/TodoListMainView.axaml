<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:TodoListPlugin.ViewModels"
             xmlns:views="using:TodoListPlugin.Views"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="600"
             x:Class="TodoListPlugin.Views.TodoListMainView"
             x:DataType="vm:TodoListMainViewModel">
    
    <UserControl.Styles>
        <!-- 项目列表项样式 -->
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="12,10"/>
            <Setter Property="Margin" Value="4,2"/>
            <Setter Property="CornerRadius" Value="6"/>
        </Style>
        
        <!-- 状态列样式 -->
        <Style Selector="Border.status-column">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="MinWidth" Value="280"/>
            <Setter Property="MaxWidth" Value="320"/>
        </Style>
        
        <!-- 待办卡片样式 -->
        <Style Selector="Border.todo-card">
            <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="12,10"/>
            <Setter Property="Margin" Value="0,4"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        
        <Style Selector="Border.todo-card:pointerover">
            <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
        </Style>
        
        <!-- 添加按钮样式 -->
        <Style Selector="Button.add-button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
        </Style>
        
        <Style Selector="Button.add-button:pointerover">
            <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
        </Style>
    </UserControl.Styles>
    
    <Grid>
        <!-- 主内容区域 -->
        <Grid ColumnDefinitions="220,*">
        <!-- 左侧项目菜单 -->
        <Border Grid.Column="0"
                Background="{DynamicResource LayerFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                BorderThickness="0,0,1,0">
            <Grid RowDefinitions="Auto,*,Auto">
                <!-- 标题栏 -->
                <Border Grid.Row="0" Padding="16,12" 
                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                        BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="项目" 
                                   FontSize="16" 
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                        <Button Grid.Column="1"
                                Name="AddProjectButton"
                                Click="OnAddProjectClick"
                                ToolTip.Tip="添加项目"
                                Padding="6"
                                Background="Transparent">
                            <PathIcon Data="M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M13,7H11V11H7V13H11V17H13V13H17V11H13V7Z"
                                       Width="16" Height="16"/>
                        </Button>
                    </Grid>
                </Border>
                
                <!-- 项目列表 -->
                <ListBox Grid.Row="1"
                         Name="ProjectListBox"
                         ItemsSource="{Binding Projects}"
                         SelectedItem="{Binding SelectedProject}"
                         Padding="4"
                         Background="Transparent">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:ProjectBoardViewModel">
                            <Grid ColumnDefinitions="Auto,*,Auto" Tag="{Binding}">
                                <Grid.ContextMenu>
                                    <ContextMenu Opening="OnProjectContextMenuOpening">
                                        <MenuItem Header="重命名" Click="OnRenameProjectClick" Tag="{Binding}"/>
                                        <MenuItem Header="修改颜色" Click="OnChangeProjectColorClick" Tag="{Binding}"/>
                                        <Separator/>
                                        <MenuItem Header="删除" Click="OnDeleteProjectClick" Tag="{Binding}"/>
                                    </ContextMenu>
                                </Grid.ContextMenu>
                                <!-- 颜色指示器 -->
                                <Ellipse Grid.Column="0"
                                         Width="10" Height="10"
                                         Fill="{Binding Color}"
                                         Margin="0,0,10,0"
                                         VerticalAlignment="Center"/>
                                
                                <!-- 项目名称 -->
                                <TextBlock Grid.Column="1"
                                           Text="{Binding Name}"
                                           VerticalAlignment="Center"
                                           TextTrimming="CharacterEllipsis"/>
                                
                                <!-- 待办数量 -->
                                <Border Grid.Column="2"
                                        Background="{DynamicResource ControlFillColorSecondaryBrush}"
                                        CornerRadius="10"
                                        Padding="6,2"
                                        IsVisible="{Binding TotalItemCount, Converter={x:Static ObjectConverters.NotEqual}, ConverterParameter=0}">
                                    <TextBlock Text="{Binding TotalItemCount}"
                                               FontSize="11"
                                               VerticalAlignment="Center"/>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- 底部设置按钮 -->
                <Border Grid.Row="2" Padding="12"
                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                        BorderThickness="0,1,0,0">
                    <Button Name="SettingsButton"
                            Click="OnSettingsClick"
                            Background="Transparent"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Padding="8,6">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"
                                     Width="16" Height="16"/>
                            <TextBlock Text="设置" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Border>
            </Grid>
        </Border>
        
        <!-- 右侧看板区域 -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*">
            <!-- 工具栏 -->
            <Border Grid.Row="0" Padding="16,12"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1">
                <Grid ColumnDefinitions="*,Auto">
                    <!-- 项目名称 -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Ellipse Width="12" Height="12"
                                 Fill="{Binding SelectedProject.Color, FallbackValue=#2196F3}"
                                 VerticalAlignment="Center"
                                 IsVisible="{Binding HasSelectedProject}"/>
                        <TextBlock Text="{Binding SelectedProject.Name, FallbackValue=请选择项目}"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <!-- 搜索框 -->
                    <TextBox Grid.Column="1"
                             Name="SearchBox"
                             Text="{Binding SearchText}"
                             Watermark="搜索..."
                             Width="200"
                             IsVisible="{Binding HasSelectedProject}"/>
                </Grid>
            </Border>
            
            <!-- 看板内容 -->
            <ScrollViewer Grid.Row="1"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Disabled"
                          IsVisible="{Binding HasSelectedProject}">
                <ItemsControl Name="KanbanBoard"
                              ItemsSource="{Binding SelectedProject.StatusColumns}"
                              Margin="16">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="16"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="vm:StatusColumnViewModel">
                            <Border Classes="status-column"
                                    DragDrop.AllowDrop="True"
                                    Tag="{Binding}">
                                <Grid RowDefinitions="Auto,*,Auto">
                                    <!-- 状态列标题 -->
                                    <Border Grid.Row="0" Padding="8,4" Margin="0,0,0,8">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <Ellipse Grid.Column="0"
                                                     Width="8" Height="8"
                                                     Fill="{Binding Color}"
                                                     Margin="0,0,8,0"
                                                     VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding Name}"
                                                       FontWeight="SemiBold"
                                                       VerticalAlignment="Center"/>
                                            <Border Grid.Column="2"
                                                    Background="{DynamicResource ControlFillColorSecondaryBrush}"
                                                    CornerRadius="10"
                                                    Padding="8,2">
                                                <TextBlock Text="{Binding ItemCount}"
                                                           FontSize="11"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- 待办事项列表 -->
                                    <ScrollViewer Grid.Row="1"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Disabled">
                                        <ItemsControl ItemsSource="{Binding Items}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="vm:TodoItemViewModel">
                                                    <Border Classes="todo-card"
                                                            Tag="{Binding}"
                                                            IsVisible="{Binding IsVisible}"
                                                            PointerPressed="OnTodoCardPointerPressed">
                                                        <Border.ContextMenu>
                                                            <ContextMenu DataContext="{Binding}">
                                                                <MenuItem Header="编辑" Click="OnEditTodoClick" Tag="{Binding}"/>
                                                                <MenuItem Header="移动到其他项目" Click="OnMoveTodoClick" Tag="{Binding}"/>
                                                                <Separator/>
                                                                <MenuItem Header="删除" Click="OnDeleteTodoClick" Tag="{Binding}"/>
                                                            </ContextMenu>
                                                        </Border.ContextMenu>
                                                        <Grid RowDefinitions="Auto,Auto,Auto,Auto">
                                                            <!-- 标题 -->
                                                            <TextBlock Grid.Row="0"
                                                                       Text="{Binding Title}"
                                                                       TextWrapping="Wrap"
                                                                       FontWeight="Medium"/>
                                                            
                                                            <!-- 描述（如果有）-->
                                                            <TextBlock Grid.Row="1"
                                                                       Text="{Binding Description}"
                                                                       TextWrapping="Wrap"
                                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                                       FontSize="12"
                                                                       Margin="0,4,0,0"
                                                                       MaxLines="2"
                                                                       IsVisible="{Binding ShouldShowDescriptionOnCard}"/>
                                                            
                                                            <!-- 自定义字段显示 -->
                                                            <ItemsControl Grid.Row="2"
                                                                          ItemsSource="{Binding DisplayCustomFields}"
                                                                          IsVisible="{Binding HasDisplayCustomFields}"
                                                                          Margin="0,6,0,0">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,2,0,0">
                                                                            <TextBlock Text="{Binding Key}"
                                                                                       FontSize="11"
                                                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                                            <TextBlock Text=":"
                                                                                       FontSize="11"
                                                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                                            <TextBlock Text="{Binding Value}"
                                                                                       FontSize="11"
                                                                                       FontWeight="Medium"
                                                                                       MaxLines="1"
                                                                                       TextTrimming="CharacterEllipsis"/>
                                                                        </StackPanel>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                            
                                                            <!-- 底部信息 -->
                                                            <StackPanel Grid.Row="3"
                                                                        Orientation="Horizontal"
                                                                        Spacing="8"
                                                                        Margin="0,8,0,0">
                                                                <!-- 优先级 -->
                                                                <Border Background="{Binding PriorityColor, FallbackValue=#808080}"
                                                                        CornerRadius="4"
                                                                        Padding="6,2"
                                                                        IsVisible="{Binding ShouldShowPriorityOnCard}">
                                                                    <TextBlock Text="{Binding PriorityName, FallbackValue=普通}"
                                                                               FontSize="10"
                                                                               Foreground="White"/>
                                                                </Border>
                                                                
                                                                <!-- 截止日期 -->
                                                                <StackPanel Orientation="Horizontal"
                                                                            Spacing="4"
                                                                            IsVisible="{Binding ShouldShowDueDateOnCard}">
                                                                    <PathIcon Data="M19,4H18V2H16V4H8V2H6V4H5C3.89,4 3,4.9 3,6V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V6A2,2 0 0,0 19,4M19,20H5V10H19V20M19,8H5V6H19V8Z"
                                                                              Width="12" Height="12"
                                                                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                                    <TextBlock Text="{Binding DueDateText}"
                                                                               FontSize="11"
                                                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                                </StackPanel>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                    
                                    <!-- 添加待办按钮 -->
                                    <Button Grid.Row="2"
                                            Classes="add-button"
                                            Margin="0,8,0,0"
                                            Tag="{Binding Id}"
                                            Click="OnAddTodoClick">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <PathIcon Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"
                                                      Width="14" Height="14"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                            <TextBlock Text="添加待办"
                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                        </StackPanel>
                                    </Button>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
            
            <!-- 未选择项目时的提示 -->
            <StackPanel Grid.Row="1"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        IsVisible="{Binding !HasSelectedProject}">
                <PathIcon Data="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19M17,17H15V7H17V17M13,17H11V10H13V17M9,17H7V13H9V17Z"
                          Width="64" Height="64"
                          Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                <TextBlock Text="请选择或创建一个项目"
                           FontSize="16"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           Margin="0,16,0,0"/>
                <Button Content="创建新项目"
                        Margin="0,16,0,0"
                        Click="OnAddProjectClick"/>
            </StackPanel>
        </Grid>
        </Grid>
        
        <!-- 右侧详情面板 - 覆盖层 -->
        <Border Name="DetailPanelOverlay"
                Background="#AA000000"
                IsVisible="False"
                PointerPressed="OnOverlayPointerPressed">
            <Border HorizontalAlignment="Right"
                    Name="DetailPanelContainer"
                    Width="400"
                    Background="{DynamicResource SolidBackgroundFillColorBaseBrush}"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="1,0,0,0">
                <views:TodoDetailPanel x:Name="DetailPanel"/>
            </Border>
        </Border>
    </Grid>
</UserControl>
